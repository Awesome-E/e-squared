<!DOCTYPE html>
<html lang="en-US">
	<head>
	<style>
		canvas, h1 {
			display: block;
			margin: 8px auto;
			font-family: sans-serif;
			text-align: center;
		}
		.center {
			text-align: center;
		}
	</style>
	<script src="https://cdn.jsdelivr.net/npm/jsqr@1.3.1/dist/jsQR.min.js"></script>
	</head>
	<body>
		<br/>
		<div id="loadingMessage" class="center">ðŸŽ¥ Please make sure camera access is allowed<br/><br/><button>Start Camera</button></div>
		<canvas id="canvas" hidden width="240"></canvas>
		<div id="output" hidden>
			<div id="outputMessage" style="display:none;">No QR code detected.</div>
			<div hidden><b>Data:</b> <span id="outputData"></span></div>
			<h1>Scanned: 0</h1>
			<h1>Points: 0</h1>
		</div>
		<script>
			const 	video = document.createElement("video"),
					canvasElement = document.getElementById("canvas"),
					canvas = canvasElement.getContext("2d"),
					loadingMessage = document.getElementById("loadingMessage"),
					outputContainer = document.getElementById("output"),
					outputMessage = document.getElementById("outputMessage"),
					outputData = document.getElementById("outputData"),
					startBtn = document.querySelector("button"),
					scannedCodes = [];

			function drawLine(begin, end, color) {
				canvas.beginPath();
				canvas.moveTo(begin.x, begin.y);
				canvas.lineTo(end.x, end.y);
				canvas.lineWidth = 4;
				canvas.strokeStyle = color;
				canvas.stroke();
			}

			// Use facingMode: environment to attempt to get the front camera on phones
			startBtn.onclick = function(){
				startBtn.hidden = true;
				navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }).then(function(stream) {
				video.srcObject = stream;
				video.setAttribute("playsinline", true); // required to tell iOS safari we don't want fullscreen
				video.play();
				requestAnimationFrame(tick);
				});
			};

			function tick() {
				//loadingMessage.innerText = "âŒ› Loading video..."
				if (video.readyState === video.HAVE_ENOUGH_DATA) {
					loadingMessage.hidden = true;
					canvasElement.hidden = false;
					outputContainer.hidden = false;

					let scale = window.innerWidth / video.videoWidth * 0.8;

					canvasElement.height = video.videoHeight * scale;
					canvasElement.width = video.videoWidth * scale;
					canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
					var imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
					var code = jsQR(imageData.data, imageData.width, imageData.height, {
						inversionAttempts: "dontInvert",
					});
					if (code && code.data && scannedCodes.indexOf(code.data) === -1) {
						drawLine(code.location.topLeftCorner, code.location.topRightCorner, "#FF3B58");
						drawLine(code.location.topRightCorner, code.location.bottomRightCorner, "#FF3B58");
						drawLine(code.location.bottomRightCorner, code.location.bottomLeftCorner, "#FF3B58");
						drawLine(code.location.bottomLeftCorner, code.location.topLeftCorner, "#FF3B58");
						outputMessage.hidden = true;
						//outputData.parentElement.hidden = false;
						scannedCodes.push(outputData.innerText = code.data);
					} else if (code && code.data) {
						outputMessage.hidden = true;
						//outputData.parentElement.hidden = false;
						outputData.innerText = "Already Scanned";
					} else {
						outputMessage.hidden = false;
						outputData.parentElement.hidden = true;
					}
				}
				requestAnimationFrame(tick);
			}
		</script>
	</body>
</html>